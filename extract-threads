#!/usr/bin/python
# -*- coding: utf-8 -*-

from sys import argv
import praw
from math import log,log10
import json


r = praw.Reddit('Programa Podemos Arag√≥n 1.0')
sub=r.get_subreddit('podemos').get_new(limit=1000)

T=3.5
proposals=[]

if len(argv) < 2:
	print "Usage: " + argv[0] + " <link_flair_tag>"
	exit(1)

flair = argv[1].lower()
for s in sub:
	print s.link_flair_text
#	if s.link_flair_css_class == 'propuesta':
	if s.link_flair_css_class== flair:
		print s
		p={}
		p['url']= s.url
		p['title']=s.title
		p['author']=str(s.author)
		ups=s.ups
		downs=s.downs
		p['ups']=ups
		p['score']=s.score
		p['comments']=len(s.comments)
		# Consensus
#		if hasattr(s, 'upvote_ratio'):
#			ratio = s.upvote_ratio
#		else:
#			ratio=r.get_submission(submission_id=s.id).upvote_ratio
#		consensus=log(ups+downs,2) * (ratio*2-1) 
#		p['consensus']=consensus
#		p['ratio']=ratio

		# Decelerated hotness
		timeweight = 45000.0 * 2 * T #Reddit -> T=0.5 - ~12h
		score=s.score
		seconds = s.created
		sc = log10(max(abs(score)+1, 1))
		if score > 0:
			sign = 1
		elif score < 0:
			sign = -1
		else:
			sign = 0
		hotness = round(sign * sc + seconds / timeweight, 7) 
		p['hotness']=hotness

		proposals=proposals+[p]
		p['accepted']=score>22
		
		#Answers
		p['response']=False
		for comment in s.comments:
			if str(comment.author)=='CCAragon':
				p['response']=True


proposals = sorted(proposals, key=lambda obj: obj['hotness'], reverse=True)

if len(proposals):
	with open(flair+'.json', 'w') as outfile:
		json.dump(proposals, outfile)

